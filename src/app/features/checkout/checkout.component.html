<app-header></app-header>

<main class="checkout-page">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Finaliser ma commande</h1>
      <div class="checkout-steps">
        <div class="step" [class.active]="currentStep() === 'shipping'" [class.completed]="currentStep() !== 'shipping'">
          <div class="step-number">1</div>
          <span>Livraison</span>
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="currentStep() === 'payment'" [class.completed]="currentStep() === 'confirmation'">
          <div class="step-number">2</div>
          <span>Paiement</span>
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="currentStep() === 'confirmation'">
          <div class="step-number">3</div>
          <span>Confirmation</span>
        </div>
      </div>
    </div>

    @if (!orderCompleted()) {
      <div class="checkout-content">
        <!-- Main Content -->
        <div class="checkout-main">
          <!-- Step 1: Shipping -->
          @if (currentStep() === 'shipping') {
            <div class="checkout-section animate-slide-up">
              <h2 class="section-title">Informations de livraison</h2>
              
              <form [formGroup]="shippingForm" class="checkout-form">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Prénom*</label>
                    <input type="text" class="form-input" formControlName="firstName" placeholder="Jean">
                    @if (shippingForm.get('firstName')?.touched && shippingForm.get('firstName')?.invalid) {
                      <span class="form-error">Le prénom est requis</span>
                    }
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Nom*</label>
                    <input type="text" class="form-input" formControlName="lastName" placeholder="Dupont">
                    @if (shippingForm.get('lastName')?.touched && shippingForm.get('lastName')?.invalid) {
                      <span class="form-error">Le nom est requis</span>
                    }
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Email*</label>
                    <input type="email" class="form-input" formControlName="email" placeholder="jean.dupont@example.com">
                    @if (shippingForm.get('email')?.touched && shippingForm.get('email')?.invalid) {
                      <span class="form-error">Email valide requis</span>
                    }
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Téléphone*</label>
                    <input type="tel" class="form-input" formControlName="phone" placeholder="+33 6 12 34 56 78">
                    @if (shippingForm.get('phone')?.touched && shippingForm.get('phone')?.invalid) {
                      <span class="form-error">Le téléphone est requis</span>
                    }
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Adresse*</label>
                  <input type="text" class="form-input" formControlName="address" placeholder="12 rue de la République">
                  @if (shippingForm.get('address')?.touched && shippingForm.get('address')?.invalid) {
                    <span class="form-error">L'adresse est requise</span>
                  }
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Ville*</label>
                    <input type="text" class="form-input" formControlName="city" placeholder="Paris">
                    @if (shippingForm.get('city')?.touched && shippingForm.get('city')?.invalid) {
                      <span class="form-error">La ville est requise</span>
                    }
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Code postal*</label>
                    <input type="text" class="form-input" formControlName="postalCode" placeholder="75001">
                    @if (shippingForm.get('postalCode')?.touched && shippingForm.get('postalCode')?.invalid) {
                      <span class="form-error">Le code postal est requis</span>
                    }
                  </div>

                  <div class="form-group">
                    <label class="form-label">Pays*</label>
                    <select class="form-select" formControlName="country">
                      <option value="France">France</option>
                      <option value="Belgique">Belgique</option>
                      <option value="Suisse">Suisse</option>
                      <option value="Luxembourg">Luxembourg</option>
                    </select>
                  </div>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" routerLink="/cart">
                    Retour au panier
                  </button>
                  <button type="button" class="btn btn-primary btn-lg" (click)="goToStep('payment')">
                    Continuer vers le paiement
                    <svg viewBox="0 0 24 24" fill="none">
                      <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </div>
              </form>
            </div>
          }

          <!-- Step 2: Payment -->
          @if (currentStep() === 'payment') {
            <div class="checkout-section animate-slide-up">
              <h2 class="section-title">Paiement sécurisé</h2>
              
              <div class="security-badge">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
                  <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>Vos informations sont protégées et cryptées</span>
              </div>

              <form [formGroup]="paymentForm" class="checkout-form">
                <div class="form-group">
                  <label class="form-label">Numéro de carte*</label>
                  <input 
                    type="text" 
                    class="form-input card-input" 
                    formControlName="cardNumber" 
                    placeholder="1234 5678 9012 3456"
                    maxlength="16">
                  @if (paymentForm.get('cardNumber')?.touched && paymentForm.get('cardNumber')?.invalid) {
                    <span class="form-error">Numéro de carte invalide (16 chiffres)</span>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">Nom sur la carte*</label>
                  <input type="text" class="form-input" formControlName="cardName" placeholder="JEAN DUPONT">
                  @if (paymentForm.get('cardName')?.touched && paymentForm.get('cardName')?.invalid) {
                    <span class="form-error">Le nom est requis</span>
                  }
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Date d'expiration*</label>
                    <input type="text" class="form-input" formControlName="expiryDate" placeholder="MM/AA" maxlength="5">
                    @if (paymentForm.get('expiryDate')?.touched && paymentForm.get('expiryDate')?.invalid) {
                      <span class="form-error">Format MM/AA requis</span>
                    }
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">CVV*</label>
                    <input type="text" class="form-input" formControlName="cvv" placeholder="123" maxlength="4">
                    @if (paymentForm.get('cvv')?.touched && paymentForm.get('cvv')?.invalid) {
                      <span class="form-error">CVV invalide</span>
                    }
                  </div>
                </div>

                <div class="payment-note">
                  <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <p>Ceci est une démonstration. Aucun paiement réel ne sera effectué.</p>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" (click)="goToStep('shipping')">
                    <svg viewBox="0 0 24 24" fill="none">
                      <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Retour
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-primary btn-lg" 
                    (click)="submitOrder()"
                    [disabled]="isProcessing()">
                    @if (isProcessing()) {
                      <span class="spinner"></span>
                      <span>Traitement...</span>
                    } @else {
                      <svg viewBox="0 0 24 24" fill="none">
                        <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                      <span>Confirmer et payer {{ cartSummary().total | number:'1.2-2' }} €</span>
                    }
                  </button>
                </div>
              </form>
            </div>
          }
        </div>

        <!-- Order Summary Sidebar -->
        <div class="order-summary-sidebar">
          <div class="summary-card">
            <h3 class="summary-title">Récapitulatif</h3>
            
            <div class="summary-items">
              @for (item of cartSummary().items; track item.id) {
                <div class="summary-item">
                  <div class="item-info">
                    <div class="item-name">{{ item.productTitle }}</div>
                    <div class="item-qty">Qté: {{ item.quantity }}</div>
                  </div>
                  <div class="item-price">{{ item.price * item.quantity | number:'1.2-2' }} €</div>
                </div>
              }
            </div>

            <div class="summary-totals">
              <div class="summary-row">
                <span>Sous-total</span>
                <span>{{ cartSummary().subtotal | number:'1.2-2' }} €</span>
              </div>
              <div class="summary-row">
                <span>Livraison</span>
                <span class="text-success">Gratuite</span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-row summary-total">
                <span>Total</span>
                <span>{{ cartSummary().total | number:'1.2-2' }} €</span>
              </div>
            </div>
          </div>

          <div class="trust-badges">
            <div class="badge-item">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>Paiement sécurisé</span>
            </div>
            <div class="badge-item">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M21 10H3M21 6H3M21 14H3M21 18H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>Livraison gratuite</span>
            </div>
            <div class="badge-item">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2"/>
                <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>Retour 14 jours</span>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <!-- Confirmation Step -->
      <div class="confirmation-section animate-fade-in">
        <div class="success-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        
        <h2 class="confirmation-title">Commande confirmée !</h2>
        <p class="confirmation-text">
          Votre commande <strong>#{{ orderNumber() }}</strong> a été enregistrée avec succès.
          <br>
          Vous recevrez un email de confirmation à l'adresse <strong>{{ shippingForm.value.email }}</strong>
        </p>

        <div class="confirmation-actions">
          <button class="btn btn-primary btn-lg" (click)="viewOrders()">
            Voir mes commandes
          </button>
          <button class="btn btn-secondary" (click)="continueShopping()">
            Continuer mes achats
          </button>
        </div>

        <div class="order-details-card">
          <h3>Détails de la commande</h3>
          <div class="detail-row">
            <span>Montant total</span>
            <strong>{{ cartSummary().total | number:'1.2-2' }} €</strong>
          </div>
          <div class="detail-row">
            <span>Livraison estimée</span>
            <strong>3-5 jours ouvrés</strong>
          </div>
          <div class="detail-row">
            <span>Adresse de livraison</span>
            <span>
              {{ shippingForm.value.address }}<br>
              {{ shippingForm.value.postalCode }} {{ shippingForm.value.city }}
            </span>
          </div>
        </div>
      </div>
    }
  </div>
</main>

<app-footer></app-footer>
