<app-header></app-header>

<main class="checkout-page">
  <div class="container">
    <!-- Indicateur d'√©tapes -->
    <div class="steps-indicator">
      <div class="step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
        <div class="step-number">1</div>
        <div class="step-label">Livraison</div>
      </div>
      <div class="step-line" [class.active]="currentStep() >= 2"></div>
      <div class="step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
        <div class="step-number">2</div>
        <div class="step-label">Paiement</div>
      </div>
      <div class="step-line" [class.active]="currentStep() >= 3"></div>
      <div class="step" [class.active]="currentStep() >= 3">
        <div class="step-number">3</div>
        <div class="step-label">Confirmation</div>
      </div>
    </div>

    <div class="checkout-content">
      <!-- √âtape 1: Adresse de livraison -->
      @if (currentStep() === 1) {
        <div class="step-content shipping-step animate-slide-in">
          <h2 class="step-title">üì¶ Adresse de livraison</h2>

          <!-- Adresses sauvegard√©es -->
          @if (savedAddresses().length > 0) {
            <div class="saved-addresses">
              <h3>Mes adresses</h3>
              <div class="addresses-grid">
                @for (address of savedAddresses(); track address.id) {
                  <div 
                    class="address-card" 
                    [class.selected]="selectedAddressId() === address.id"
                    (click)="selectAddress(address.id)">
                    @if (address.isDefault) {
                      <span class="default-badge">Par d√©faut</span>
                    }
                    <div class="address-name">{{ address.firstName }} {{ address.lastName }}</div>
                    <div class="address-details">
                      <p>{{ address.street }}</p>
                      <p>{{ address.postalCode }} {{ address.city }}</p>
                      <p>{{ address.country }}</p>
                      <p class="phone">üìû {{ address.phone }}</p>
                    </div>
                    @if (selectedAddressId() === address.id) {
                      <div class="selected-check">‚úì</div>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Bouton ajouter nouvelle adresse -->
          <button 
            type="button" 
            class="btn-add-address" 
            (click)="toggleNewAddressForm()">
            {{ showNewAddressForm() ? '‚Üê Retour aux adresses' : '+ Ajouter une nouvelle adresse' }}
          </button>

          <!-- Formulaire nouvelle adresse -->
          @if (showNewAddressForm()) {
            <form [formGroup]="newAddressForm" class="new-address-form animate-fade-in">
              <div class="form-row">
                <div class="form-group">
                  <label for="firstName">Pr√©nom *</label>
                  <input 
                    id="firstName" 
                    type="text" 
                    formControlName="firstName" 
                    placeholder="Pr√©nom"
                    [class.error]="newAddressForm.get('firstName')?.touched && newAddressForm.get('firstName')?.invalid">
                </div>
                <div class="form-group">
                  <label for="lastName">Nom *</label>
                  <input 
                    id="lastName" 
                    type="text" 
                    formControlName="lastName" 
                    placeholder="Nom"
                    [class.error]="newAddressForm.get('lastName')?.touched && newAddressForm.get('lastName')?.invalid">
                </div>
              </div>

              <div class="form-group">
                <label for="phone">T√©l√©phone *</label>
                <input 
                  id="phone" 
                  type="tel" 
                  formControlName="phone" 
                  placeholder="+33 6 12 34 56 78"
                  [class.error]="newAddressForm.get('phone')?.touched && newAddressForm.get('phone')?.invalid">
              </div>

              <div class="form-group">
                <label for="street">Adresse *</label>
                <input 
                  id="street" 
                  type="text" 
                  formControlName="street" 
                  placeholder="123 Rue de la Paix"
                  [class.error]="newAddressForm.get('street')?.touched && newAddressForm.get('street')?.invalid">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="postalCode">Code postal *</label>
                  <input 
                    id="postalCode" 
                    type="text" 
                    formControlName="postalCode" 
                    placeholder="75001"
                    [class.error]="newAddressForm.get('postalCode')?.touched && newAddressForm.get('postalCode')?.invalid">
                </div>
                <div class="form-group">
                  <label for="city">Ville *</label>
                  <input 
                    id="city" 
                    type="text" 
                    formControlName="city" 
                    placeholder="Paris"
                    [class.error]="newAddressForm.get('city')?.touched && newAddressForm.get('city')?.invalid">
                </div>
              </div>

              <div class="form-group">
                <label for="country">Pays *</label>
                <input 
                  id="country" 
                  type="text" 
                  formControlName="country" 
                  placeholder="France"
                  [class.error]="newAddressForm.get('country')?.touched && newAddressForm.get('country')?.invalid">
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input type="checkbox" formControlName="isDefault">
                  <span>D√©finir comme adresse par d√©faut</span>
                </label>
              </div>

              <button 
                type="button" 
                class="btn-save-address" 
                (click)="saveNewAddress()"
                [disabled]="newAddressForm.invalid">
                Enregistrer cette adresse
              </button>
            </form>
          }

          <!-- Mode de livraison -->
          <div class="delivery-method-section">
            <h3 class="section-title">üöö Mode de livraison</h3>
            <div class="delivery-methods">
              <div 
                class="delivery-option"
                [class.selected]="deliveryMethod() === 'home'"
                (click)="selectDeliveryMethod('home')">
                <div class="delivery-info">
                  <div class="delivery-icon">üè†</div>
                  <div class="delivery-details">
                    <h4>Livraison √† domicile</h4>
                    <p>Livraison sous 3-5 jours ouvr√©s</p>
                  </div>
                </div>
                <div class="delivery-price">
                  @if (cartSummary().subtotal >= FREE_SHIPPING_THRESHOLD) {
                    <span class="free-badge">GRATUIT</span>
                    <small class="original-price">9,90 ‚Ç¨</small>
                  } @else {
                    <span class="price">9,90 ‚Ç¨</span>
                  }
                </div>
                @if (deliveryMethod() === 'home') {
                  <div class="selected-check">‚úì</div>
                }
              </div>

              <div 
                class="delivery-option"
                [class.selected]="deliveryMethod() === 'pickup'"
                (click)="selectDeliveryMethod('pickup')">
                <div class="delivery-info">
                  <div class="delivery-icon">üì¶</div>
                  <div class="delivery-details">
                    <h4>Retrait en magasin</h4>
                    <p>Disponible sous 24h</p>
                  </div>
                </div>
                <div class="delivery-price">
                  <span class="free-badge">GRATUIT</span>
                </div>
                @if (deliveryMethod() === 'pickup') {
                  <div class="selected-check">‚úì</div>
                }
              </div>
            </div>

            @if (deliveryMethod() === 'home' && cartSummary().subtotal < FREE_SHIPPING_THRESHOLD) {
              <div class="free-shipping-info">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span>Plus que {{ (FREE_SHIPPING_THRESHOLD - cartSummary().subtotal).toFixed(2) }} ‚Ç¨ pour la livraison gratuite !</span>
              </div>
            }
          </div>

          <div class="step-actions">
            <button type="button" class="btn-next" (click)="goToStep(2)">
              Continuer vers le paiement ‚Üí
            </button>
          </div>
        </div>
      }

      <!-- √âtape 2: Paiement -->
      @if (currentStep() === 2) {
        <div class="step-content payment-step animate-slide-in">
          <h2 class="step-title">üí≥ Mode de paiement</h2>

          <!-- S√©lection du mode de paiement -->
          <div class="payment-methods">
            <div 
              class="payment-method" 
              [class.selected]="paymentMethod() === 'card'"
              (click)="selectPaymentMethod('card')">
              <div class="method-icon">üí≥</div>
              <div class="method-info">
                <div class="method-name">Carte bancaire</div>
                <div class="method-desc">Visa, Mastercard, Amex</div>
              </div>
              @if (paymentMethod() === 'card') {
                <div class="selected-check">‚úì</div>
              }
            </div>

            <div 
              class="payment-method disabled"
              [class.selected]="paymentMethod() === 'paypal'"
              (click)="selectPaymentMethod('paypal')">
              <div class="method-icon">üÖøÔ∏è</div>
              <div class="method-info">
                <div class="method-name">PayPal</div>
                <div class="method-desc">Bient√¥t disponible</div>
              </div>
              @if (paymentMethod() === 'paypal') {
                <div class="selected-check">‚úì</div>
              }
            </div>

            <div 
              class="payment-method disabled"
              [class.selected]="paymentMethod() === 'bank-transfer'"
              (click)="selectPaymentMethod('bank-transfer')">
              <div class="method-icon">üè¶</div>
              <div class="method-info">
                <div class="method-name">Virement bancaire</div>
                <div class="method-desc">Bient√¥t disponible</div>
              </div>
              @if (paymentMethod() === 'bank-transfer') {
                <div class="selected-check">‚úì</div>
              }
            </div>
          </div>

          <!-- Formulaire de paiement Stripe -->
          @if (paymentMethod() === 'card') {
            <form [formGroup]="paymentForm" class="payment-form animate-fade-in">
              <div class="form-group">
                <label for="cardholderName">Nom sur la carte *</label>
                <input 
                  id="cardholderName" 
                  type="text" 
                  formControlName="cardholderName" 
                  placeholder="Jean Dupont"
                  [class.error]="paymentForm.get('cardholderName')?.touched && paymentForm.get('cardholderName')?.invalid">
              </div>

              <div class="form-group">
                <label>Informations de la carte *</label>
                <div #stripeCard class="stripe-card-element" id="card-element"></div>
              </div>

              <div class="secure-badge">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>Paiement 100% s√©curis√© avec Stripe</span>
              </div>
            </form>
          }

          <div class="step-actions">
            <button type="button" class="btn-back" (click)="goToStep(1)">
              ‚Üê Retour
            </button>
            <button 
              type="button" 
              class="btn-next" 
              (click)="submitOrder()"
              [disabled]="isProcessing() || (paymentMethod() === 'card' && !stripeReady())">
              @if (isProcessing()) {
                <span class="spinner"></span>
                Traitement...
              } @else {
                Confirmer le paiement ({{ finalTotal().toFixed(2) }}‚Ç¨)
              }
            </button>
          </div>
        </div>
      }

      <!-- √âtape 3: Confirmation -->
      @if (currentStep() === 3) {
        <div class="step-content confirmation-step animate-scale-in">
          <div class="success-animation">
            <div class="checkmark-circle">
              <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark-circle-path" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
              </svg>
            </div>
          </div>

          <h2 class="confirmation-title">üéâ Commande confirm√©e !</h2>
          <p class="confirmation-message">
            Merci pour votre achat ! Votre commande a √©t√© trait√©e avec succ√®s.
          </p>

          <div class="order-info">
            <div class="order-number">
              <span class="label">Num√©ro de commande :</span>
              <span class="value">{{ orderNumber() }}</span>
            </div>
            <p class="confirmation-email">
              Un email de confirmation a √©t√© envoy√© √† <strong>{{ currentUser()?.email }}</strong>
            </p>
          </div>

          <div class="confirmation-actions">
            <button type="button" class="btn-primary" (click)="viewOrders()">
              Voir mes commandes
            </button>
            <button type="button" class="btn-secondary" (click)="continueShopping()">
              Continuer mes achats
            </button>
          </div>
        </div>
      }

      <!-- R√©capitulatif du panier (sidebar) -->
      <aside class="order-summary">
        <h3>R√©capitulatif de commande</h3>
        
        <div class="summary-items">
          @for (item of cartSummary().items; track item.id) {
            <div class="summary-item">
              <img [src]="item.productImage || 'assets/placeholder.jpg'" [alt]="item.productTitle">
              <div class="item-info">
                <div class="item-name">{{ item.productTitle }}</div>
                <div class="item-quantity">Qt√©: {{ item.quantity }}</div>
              </div>
              <div class="item-price">{{ item.price * item.quantity }}‚Ç¨</div>
            </div>
          }
        </div>

        <div class="summary-divider"></div>

        <div class="summary-row">
          <span>Sous-total</span>
          <span>{{ cartSummary().subtotal }}‚Ç¨</span>
        </div>

        <div class="summary-row">
          <span>Livraison</span>
          @if (shippingCost() === 0 && deliveryMethod() === 'pickup') {
            <span class="free-shipping">Retrait gratuit</span>
          } @else if (shippingCost() === 0 && deliveryMethod() === 'home') {
            <span class="free-shipping">Gratuite</span>
          } @else {
            <span>{{ shippingCost().toFixed(2) }}‚Ç¨</span>
          }
        </div>

        <div class="summary-divider"></div>

        <div class="summary-total">
          <span>Total</span>
          <span class="total-amount">{{ finalTotal().toFixed(2) }}‚Ç¨</span>
        </div>

        <!-- Mode de livraison s√©lectionn√© -->
        @if (currentStep() >= 1) {
          <div class="selected-delivery-info">
            @if (deliveryMethod() === 'home') {
              <p class="delivery-mode">üöö Livraison √† domicile</p>
            } @else {
              <p class="delivery-mode">üì¶ Retrait en magasin</p>
            }
          </div>
        }

        <!-- Adresse de livraison s√©lectionn√©e -->
        @if (currentStep() >= 2 && selectedAddress() && deliveryMethod() === 'home') {
          <div class="selected-shipping-address">
            <h4>üìç Livraison √† :</h4>
            <p class="address-line">{{ selectedAddress()!.firstName }} {{ selectedAddress()!.lastName }}</p>
            <p class="address-line">{{ selectedAddress()!.street }}</p>
            <p class="address-line">{{ selectedAddress()!.postalCode }} {{ selectedAddress()!.city }}</p>
            <p class="address-line">{{ selectedAddress()!.country }}</p>
          </div>
        }
      </aside>
    </div>
  </div>
</main>

<app-footer></app-footer>
