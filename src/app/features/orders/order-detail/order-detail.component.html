<app-header></app-header>

<main class="order-detail-page">
  <div class="container">
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Chargement des d√©tails de la commande...</p>
      </div>
    } @else if (errorMessage()) {
      <div class="error-state">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <h2>Erreur</h2>
        <p>{{ errorMessage() }}</p>
        <button class="btn btn-primary" (click)="goBack()">Retour aux commandes</button>
      </div>
    } @else if (order()) {
      <!-- En-t√™te avec num√©ro de commande -->
      <div class="page-header">
        <button class="btn-back" (click)="goBack()">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M19 12H5M5 12l7 7M5 12l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Retour
        </button>
        <div class="header-content">
          <h1 class="page-title">{{ getOrderNumber() }}</h1>
          <span class="badge" [ngClass]="getStatusBadgeClass(order()!.status)">
            {{ getStatusLabel(order()!.status) }}
          </span>
        </div>
        <p class="order-date">Command√© le {{ order()!.createdAt | date:'dd/MM/yyyy √† HH:mm' }}</p>
      </div>

      <div class="order-content">
        <!-- Colonne gauche: Articles -->
        <div class="order-main">
          <!-- Articles command√©s -->
          <div class="section card">
            <h2 class="section-title">Articles command√©s</h2>
            <div class="items-list">
              @for (item of order()!.items; track item.id) {
                <div class="item-row">
                  <div class="item-image">
                    @if (item.productImage) {
                      <img [src]="item.productImage" [alt]="item.productTitle">
                    } @else {
                      <div class="placeholder-image">
                        <svg viewBox="0 0 24 24" fill="none">
                          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                          <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
                          <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </div>
                    }
                  </div>

                  <div class="item-details">
                    <h3 class="item-title">{{ item.productTitle }}</h3>
                    @if (item.productBrand) {
                      <p class="item-brand">{{ item.productBrand }}</p>
                    }
                    @if (item.conditionNote) {
                      <p class="item-condition">√âtat: {{ item.conditionNote }}</p>
                    }
                    @if (item.sellerShopName) {
                      <p class="item-seller">Vendu par {{ item.sellerShopName }}</p>
                    }
                    <p class="item-quantity">Quantit√©: {{ item.quantity }}</p>

                    <!-- Assurance si pr√©sente -->
                    @if (item.insurance) {
                      <div class="item-insurance">
                        <svg viewBox="0 0 24 24" fill="none">
                          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <div class="insurance-details">
                          <strong>{{ item.insurance.name }}</strong>
                          <span>{{ item.insurance.price | number:'1.2-2' }} ‚Ç¨</span>
                        </div>
                      </div>
                    }

                    <!-- Livraison estim√©e -->
                    @if (item.estimatedDeliveryMin && item.estimatedDeliveryMax) {
                      <div class="item-delivery">
                        <svg viewBox="0 0 24 24" fill="none">
                          <rect x="1" y="3" width="15" height="13" stroke="currentColor" stroke-width="2"/>
                          <path d="M16 8h5l3 3v5h-4" stroke="currentColor" stroke-width="2"/>
                          <circle cx="5.5" cy="19.5" r="2.5" stroke="currentColor" stroke-width="2"/>
                          <circle cx="18.5" cy="19.5" r="2.5" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Livraison estim√©e: {{ item.estimatedDeliveryMin | date:'dd/MM' }} - {{ item.estimatedDeliveryMax | date:'dd/MM' }}</span>
                      </div>
                    }
                  </div>

                  <div class="item-pricing">
                    <div class="item-price">{{ item.price | number:'1.2-2' }} ‚Ç¨</div>
                    @if (item.quantity > 1) {
                      <div class="item-subtotal">{{ item.price * item.quantity | number:'1.2-2' }} ‚Ç¨</div>
                    }
                    @if (item.insurance) {
                      <div class="insurance-total">
                        + {{ item.insurance.price | number:'1.2-2' }} ‚Ç¨ (assurance)
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Suivi de livraison -->
          <div class="section card">
            <h2 class="section-title">Suivi de livraison</h2>
            <div class="tracking-timeline">
              <div class="timeline-step" [class.completed]="order()!.status !== 'CREATED'">
                <div class="step-icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="step-content">
                  <h4>Commande confirm√©e</h4>
                  <p>{{ order()!.createdAt | date:'dd/MM/yyyy √† HH:mm' }}</p>
                </div>
              </div>

              <div class="timeline-step" [class.completed]="order()!.status === 'SHIPPED' || order()!.status === 'COMPLETED'">
                <div class="step-icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <rect x="1" y="3" width="15" height="13" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 8h5l3 3v5h-4" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="step-content">
                  <h4>Exp√©di√©e</h4>
                  @if (order()!.status === 'SHIPPED' || order()!.status === 'COMPLETED') {
                    <p>En cours de livraison</p>
                  } @else {
                    <p>En attente d'exp√©dition</p>
                  }
                </div>
              </div>

              <div class="timeline-step" [class.completed]="order()!.status === 'COMPLETED'">
                <div class="step-icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="step-content">
                  <h4>Livr√©e</h4>
                  @if (order()!.status === 'COMPLETED') {
                    <p>Commande termin√©e</p>
                  } @else {
                    <p>En attente de livraison</p>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Colonne droite: R√©sum√© -->
        <div class="order-sidebar">
          <!-- R√©sum√© de la commande -->
          <div class="section card">
            <h2 class="section-title">R√©sum√©</h2>
            <div class="summary-row">
              <span>Sous-total</span>
              <span>{{ order()!.subtotal | number:'1.2-2' }} ‚Ç¨</span>
            </div>
            @if (order()!.insuranceTotal && order()!.insuranceTotal > 0) {
              <div class="summary-row">
                <span>Assurance</span>
                <span>{{ order()!.insuranceTotal | number:'1.2-2' }} ‚Ç¨</span>
              </div>
            }
            @if (order()!.shippingTotal && order()!.shippingTotal > 0) {
              <div class="summary-row">
                <span>Livraison</span>
                <span>{{ order()!.shippingTotal | number:'1.2-2' }} ‚Ç¨</span>
              </div>
            } @else {
              <div class="summary-row free">
                <span>Livraison</span>
                <span class="free-badge">GRATUITE</span>
              </div>
            }
            <div class="summary-divider"></div>
            <div class="summary-row total">
              <span>Total</span>
              <strong>{{ order()!.total | number:'1.2-2' }} ‚Ç¨</strong>
            </div>
          </div>

          <!-- Adresse de livraison -->
          <div class="section card">
            <h2 class="section-title">Adresse de livraison</h2>
            <div class="address-content">
              <svg class="address-icon" viewBox="0 0 24 24" fill="none">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <div class="address-text">
                <p>John Doe</p>
                <p>123 Rue de la Paix</p>
                <p>75001 Paris</p>
                <p>France</p>
                <p class="address-phone">üìû +33 6 12 34 56 78</p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="section card">
            <h2 class="section-title">Actions</h2>
            <div class="actions-list">
              <button class="action-btn">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
                </svg>
                Contacter le vendeur
              </button>
              @if (order()!.status === 'COMPLETED') {
                <button class="action-btn">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M3 12a9 9 0 1009-9 9.75 9.75 0 00-6.74 2.74L3 8M3 3v5h5" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Commander √† nouveau
                </button>
              }
              @if (order()!.status !== 'CANCELLED' && order()!.status !== 'COMPLETED') {
                <button class="action-btn danger">
                  <svg viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Annuler la commande
                </button>
              }
            </div>
          </div>

          <!-- Besoin d'aide -->
          <div class="section card help-section">
            <h2 class="section-title">Besoin d'aide ?</h2>
            <p>Notre service client est disponible 7j/7</p>
            <button class="btn btn-secondary btn-block">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M8.56 3.69a9.004 9.004 0 016.88 0M12 20v1M3.34 7a9 9 0 100 10M20.66 7a9 9 0 010 10" stroke="currentColor" stroke-width="2"/>
              </svg>
              Centre d'aide
            </button>
          </div>
        </div>
      </div>
    }
  </div>
</main>

<app-footer></app-footer>
